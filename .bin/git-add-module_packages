#!/usr/bin/env bash
# =============================================================================
# git-add-module_packages
# =============================================================================
# Add a git repository as a submodule to tools/packages/
#
# Usage:
#   .bin/git-add-module_packages
#   .bin/git-add-module_packages <repo_url> <folder_name>
#
# Example:
#   .bin/git-add-module_packages https://github.com/thinkeloquent/mta_app_yaml_config app_yaml_config
# =============================================================================

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Get the repository root directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
PACKAGES_DIR="tools/packages"
PACKAGES_PATH="$REPO_ROOT/$PACKAGES_DIR"

# -----------------------------------------------------------------------------
# Helper Functions
# -----------------------------------------------------------------------------

print_header() {
    echo -e "${CYAN}"
    echo "============================================================================="
    echo " Git Submodule Installer - tools/packages"
    echo "============================================================================="
    echo -e "${NC}"
}

print_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

print_error() {
    echo -e "${RED}✗ $1${NC}"
}

print_info() {
    echo -e "${BLUE}→ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

validate_url() {
    local url="$1"
    if [[ ! "$url" =~ ^https?:// ]] && [[ ! "$url" =~ ^git@ ]]; then
        return 1
    fi
    return 0
}

validate_folder_name() {
    local folder="$1"
    # Check for valid folder name (alphanumeric, underscore, hyphen)
    if [[ ! "$folder" =~ ^[a-zA-Z][a-zA-Z0-9_-]*$ ]]; then
        return 1
    fi
    return 0
}

extract_folder_from_url() {
    local url="$1"
    # Extract repo name from URL and convert to folder format
    local repo_name
    repo_name=$(basename "$url" .git)
    # Remove common prefixes like mta_ or mta-
    repo_name="${repo_name#mta_}"
    repo_name="${repo_name#mta-}"
    # Convert hyphens to underscores for consistency
    echo "${repo_name//-/_}"
}

# -----------------------------------------------------------------------------
# Main Script
# -----------------------------------------------------------------------------

print_header

# Change to repository root
cd "$REPO_ROOT"

# Ensure packages directory exists
if [[ ! -d "$PACKAGES_PATH" ]]; then
    print_info "Creating packages directory: $PACKAGES_DIR"
    mkdir -p "$PACKAGES_PATH"
fi

# Get repo URL (from argument or prompt)
if [[ -n "${1:-}" ]]; then
    REPO_URL="$1"
else
    echo -e "${YELLOW}Enter the Git repository URL:${NC}"
    echo -e "${CYAN}  Example: https://github.com/thinkeloquent/mta_app_yaml_config${NC}"
    read -rp "> " REPO_URL
fi

# Validate URL
if ! validate_url "$REPO_URL"; then
    print_error "Invalid URL format: $REPO_URL"
    print_info "URL must start with https://, http://, or git@"
    exit 1
fi

print_success "Repository URL: $REPO_URL"

# Suggest folder name based on URL
SUGGESTED_FOLDER=$(extract_folder_from_url "$REPO_URL")

# Get folder name (from argument or prompt)
if [[ -n "${2:-}" ]]; then
    FOLDER_NAME="$2"
else
    echo ""
    echo -e "${YELLOW}Enter the local folder name (within tools/packages/):${NC}"
    echo -e "${CYAN}  Suggested: ${SUGGESTED_FOLDER}${NC}"
    read -rp "> " FOLDER_NAME

    # Use suggested if empty
    if [[ -z "$FOLDER_NAME" ]]; then
        FOLDER_NAME="$SUGGESTED_FOLDER"
        print_info "Using suggested folder: $FOLDER_NAME"
    fi
fi

# Validate folder name
if ! validate_folder_name "$FOLDER_NAME"; then
    print_error "Invalid folder name: $FOLDER_NAME"
    print_info "Folder name must start with a letter and contain only alphanumeric characters, underscores, or hyphens"
    exit 1
fi

# Full path for submodule
SUBMODULE_PATH="$PACKAGES_DIR/$FOLDER_NAME"
FULL_PATH="$REPO_ROOT/$SUBMODULE_PATH"

# Check if folder already exists
if [[ -d "$FULL_PATH" ]]; then
    print_error "Folder already exists: $SUBMODULE_PATH"
    echo ""
    echo "Options:"
    echo "  1. Remove existing folder and add as submodule"
    echo "  2. Cancel"
    read -rp "Choose [1/2]: " CHOICE

    case "$CHOICE" in
        1)
            print_warning "Removing existing folder..."
            rm -rf "$FULL_PATH"
            ;;
        *)
            print_info "Cancelled."
            exit 0
            ;;
    esac
fi

# Check if submodule already registered
if git config --file .gitmodules --get "submodule.$SUBMODULE_PATH.path" &>/dev/null; then
    print_error "Submodule already registered: $SUBMODULE_PATH"
    print_info "To remove it first, run:"
    echo "  git submodule deinit -f $SUBMODULE_PATH"
    echo "  git rm -f $SUBMODULE_PATH"
    echo "  rm -rf .git/modules/$SUBMODULE_PATH"
    exit 1
fi

# Summary before adding
echo ""
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${YELLOW}Summary:${NC}"
echo -e "  Repository:  ${GREEN}$REPO_URL${NC}"
echo -e "  Local Path:  ${GREEN}$SUBMODULE_PATH${NC}"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

read -rp "Proceed with adding submodule? [Y/n]: " CONFIRM
CONFIRM="${CONFIRM:-Y}"

if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
    print_info "Cancelled."
    exit 0
fi

# Add the submodule
echo ""
print_info "Adding git submodule..."

if git submodule add "$REPO_URL" "$SUBMODULE_PATH"; then
    print_success "Submodule added successfully!"
else
    print_error "Failed to add submodule"
    exit 1
fi

# Initialize and update
print_info "Initializing submodule..."
git submodule update --init --recursive "$SUBMODULE_PATH"

# Show result
echo ""
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${GREEN}✓ Submodule added successfully!${NC}"
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
echo -e "Location: ${CYAN}$SUBMODULE_PATH${NC}"
echo ""
echo -e "${YELLOW}Next steps:${NC}"
echo "  1. cd $SUBMODULE_PATH"
echo "  2. Review the package structure"
echo "  3. Commit the submodule addition:"
echo "     git add .gitmodules $SUBMODULE_PATH"
echo "     git commit -m \"Add $FOLDER_NAME submodule\""
echo ""

# List contents
print_info "Package contents:"
ls -la "$FULL_PATH" 2>/dev/null || true
